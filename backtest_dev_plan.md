# 📑 Phoenix 백테스트 기능 개발 계획서

## 📌 개발 목표
- 다양한 트레이딩 전략에 적용 가능한 백테스트 시스템 구현
- 과거 데이터로 전략 성능을 효율적으로 평가할 수 있는 환경 제공
- 지표 캐싱을 통한 성능 최적화와 보수적 TP/SL 처리 적용

## 🔍 개발 단계 및 구현 계획

### 1단계: 백테스트 환경 설정 구현
- **목표**: .env 파일을 통한 백테스트 설정 구현
- **작업 내용**:
  - `config/config.go`에 백테스트 설정 구조체 확장
  - .env 파일에서 다음 설정값 로드:
    ```
    BACKTEST_ENABLED=true
    BACKTEST_STRATEGY=MACD+SAR+EMA
    BACKTEST_SYMBOL=BTCUSDT
    BACKTEST_DAYS=30
    BACKTEST_INTERVAL=15m
    ```
  - 백테스트 모드 감지 및 설정 검증 기능
- **산출물**: 
  - 환경변수로 설정 가능한 백테스트 시스템

### 2단계: 지표 캐싱 시스템 구현
- **목표**: 전체 캔들에 대해 지표를 한 번만 계산하고 효율적으로 저장
- **작업 내용**:
  - `internal/backtest/indicators.go` 구현
  - 범용 `IndicatorCache` 구조체 설계
  - 전략별 필요 지표 확인 및 캐싱 메커니즘
  - 지표 결과를 인덱스로 접근할 수 있는 인터페이스 구현
- **산출물**: 
  - 캐시된 지표를 빠르게 조회할 수 있는 시스템

### 3단계: 가상 포지션 관리자 구현
- **목표**: 백테스트에서 포지션 진입/청산을 시뮬레이션하는 시스템 구현
- **작업 내용**:
  - `internal/backtest/manager.go` 구현
  - 가상 포지션 데이터 구조 설계
  - TP/SL 판정 로직 구현 (동일 봉에서 SL 우선 처리)
  - 포지션 수익/손실 계산 기능
- **산출물**: 
  - 실제 거래 없이 포지션 관리를 시뮬레이션하는 시스템

### 4단계: 백테스트 실행 엔진 구현
- **목표**: 전략에 독립적인 백테스트 실행 엔진 구현
- **작업 내용**:
  - `internal/backtest/engine.go` 구현
  - 전략 레지스트리와 연동하여 환경변수 기반 전략 선택 메커니즘 구현
  - 캔들 데이터 순회 및 시그널 생성 로직
  - 전략별 특화 로직 처리
- **산출물**: 
  - 다양한 전략에 적용 가능한 백테스트 엔진

### 5단계: 결과 분석 및 통계 시스템
- **목표**: 백테스트 결과를 분석하고 유용한 통계 제공
- **작업 내용**:
  - 트레이드 결과 기록 및 분석 구조체 설계
  - 승률, 평균 수익률, 최대 낙폭(MDD) 등 계산 로직
  - 백테스트 결과 요약 및 시각화 준비
- **산출물**: 
  - 백테스트 성능 지표 및 통계 데이터

### 6단계: 출력 및 보고 시스템
- **목표**: 백테스트 결과를 사용자 친화적으로 출력
- **작업 내용**:
  - 콘솔 출력 포맷 설계 및 구현
  - Discord 알림 연동 (기존 시스템 활용)
  - CSV 내보내기 기능 (선택적)
- **산출물**: 
  - 사용자 친화적인 결과 보고 시스템

## 🔄 실행 흐름

```
1. 프로그램 실행
   ./trader

2. 환경변수 설정 로드 (config/config.go)
   - BACKTEST_ENABLED 확인
   - 백테스트 관련 설정 로드 (전략, 심볼, 기간 등)

3. 백테스트 모드 감지 및 전략 인스턴스 생성
   - 환경변수에 지정된 전략 이름으로 전략 인스턴스 생성
   - 전략별 파라미터 설정

4. 캔들 데이터 로드
   - 바이낸스 API에서 과거 데이터 가져오기

5. 백테스트 엔진 초기화
   - 캔들 데이터, 전략 인스턴스 전달
   - 필요한 지표 계산 및 캐싱

6. 백테스트 실행
   - 각 캔들마다 전략의 시그널 생성
   - 시그널에 따른 가상 포지션 관리
   - TP/SL 체크 및 결과 기록

7. 결과 분석 및 출력
   - 성능 지표 계산
   - 결과 요약 및 시각화
   - Discord 알림 또는 CSV 저장 (옵션)
```

## 🌟 향후 확장 가능성

1. **전략 파라미터 최적화**
   - 환경변수를 통한 파라미터 튜닝 지원
   - 최적 파라미터 세트 도출
   ```
   BACKTEST_OPTIMIZATION=true
   BACKTEST_EMA_LENGTH=180,200,220
   BACKTEST_STOP_LOSS_PCT=0.01,0.02,0.03
   ```

2. **전략 비교 시스템**
   - 여러 전략을 연속으로 백테스트하여 성능 비교
   - 비교 결과 시각화
   ```
   BACKTEST_COMPARE_STRATEGIES=MACD+SAR+EMA,RSI+BB
   ```

3. **고급 시뮬레이션 기능**
   - 슬리피지 및 수수료 모델 개선
   - 유동성 시뮬레이션
   ```
   BACKTEST_SLIPPAGE_PCT=0.001
   BACKTEST_FEE_PCT=0.0004
   ```

4. **시각화 도구**
   - 트레이드 진입/청산 지점 차트 생성
   - 자산 곡선 및 낙폭 시각화
   ```
   BACKTEST_CHART_OUTPUT=true
   BACKTEST_CHART_PATH=./reports/backtest_results.html
   ```

5. **결과 저장 및 공유**
   - 백테스트 결과를 저장하고 비교할 수 있는 시스템
   - 다양한 형식(JSON, CSV 등)으로 결과 내보내기
   ```
   BACKTEST_SAVE_RESULTS=true
   BACKTEST_RESULTS_FORMAT=csv,json
   BACKTEST_RESULTS_PATH=./results/
   ```

## 🛠️ 개발 일정 (예상)
- 1-2단계: 1일
- 3-4단계: 2일
- 5-6단계: 1일
- 테스트 및 문서화: 1일

총 소요 기간: 약 5일

이 개발 계획은 환경변수(.env)를 통한 설정 방식을 사용하여 명령줄 플래그 없이도 백테스트를 쉽게 구성하고 실행할 수 있도록 설계되었습니다. 또한 기존 전략 코드를 최대한 활용하면서 다양한 전략에 적용할 수 있는 확장성 있는 백테스트 시스템을 구현합니다.